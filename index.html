<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مینی‌اپ نمونه بله — ارسال پیام به بازو</title>

  <!-- کتابخانهٔ مینی‌اپ بله -->
  <script src="https://tapi.bale.ai/miniapp.js?3"></script>

  <style>
    body{font-family: Vazirmatn,system-ui; direction: rtl; padding: 24px; max-width:700px; margin:0 auto;}
    h1{font-size:22px; margin-bottom:16px}
    input[type="text"]{width:100%; padding:10px; font-size:16px; box-sizing:border-box; margin-bottom:10px}
    button{padding:10px 14px; font-size:16px; cursor:pointer}
    #status{margin-top:12px; color: #333}
  </style>
</head>
<body>
  <h1>ارسال سریع به بازو</h1>
  <p>یک متن وارد کن و دکمهٔ «ارسال به بازو» را بزن. (این داده به بازوی بله می‌رود.)</p>

  <input id="txt" type="text" placeholder="اینجا بنویس..." />
  <div>
    <button id="sendBtn">ارسال به بازو</button>
    <button id="closeBtn" style="margin-right:8px">بستن مینی‌اپ</button>
  </div>

  <p id="status">در حال آماده‌سازی...</p>

  <script>
    // دسترسی به API مینی‌اپ بله
    const Bale = window.Bale?.WebApp;
    const status = document.getElementById('status');

    if (!Bale || !Bale.isMiniAppSupported) {
      status.innerText = 'این صفحه باید داخل اپ بله به‌عنوان مینی‌اپ باز شود.';
      // برای راحتی می‌توانیم بازبینی کنیم که initData وجود دارد یا خیر
    } else {
      Bale.ready();
      status.innerText = 'مینی‌اپ آماده است — می‌توانید پیام بفرستید. نسخه: ' + (Bale.version || '؟');

      // نمایش initData (اختیاری — برای دیباگ)
      try {
        console.log('initDataUnsafe:', Bale.initDataUnsafe);
      } catch (e) { /* ignore */ }

      document.getElementById('sendBtn').addEventListener('click', () => {
        const txt = document.getElementById('txt').value.trim();
        if (!txt) {
          status.innerText = 'لطفاً متن را وارد کنید.';
          return;
        }

        // payload را بساز
        const payload = {
          type: 'message_from_web',
          text: txt,
          ts: Date.now()
        };

        // ارسال داده به بازو — این داده به‌صورت update به بازو می‌رسد
        // پس از sendData می‌توان مینی‌اپ را بست یا پیام موفق نشان داد
        try {
          Bale.sendData(JSON.stringify(payload));
          status.innerText = 'پیام ارسال شد — منتظر تأیید از بازو بمانید...';
        } catch (err) {
          console.error(err);
          status.innerText = 'خطا در ارسال داده: ' + (err.message || err);
        }
      });

      // دکمهٔ بستن مینی‌اپ
      document.getElementById('closeBtn').addEventListener('click', () => {
        Bale.close();
      });
    }
  </script>
</body>
</html>
